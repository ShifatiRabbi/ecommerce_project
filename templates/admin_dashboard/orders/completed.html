{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Completed Orders - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.order-status-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
}
.customer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}
.amount-badge {
    background: linear-gradient(45deg, #11998e, #38ef7d);
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Completed Orders</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button class="btn btn-sm btn-outline-secondary" id="export-orders">
                <i class="fas fa-file-export me-1"></i> Export
            </button>
        </div>
        <div class="input-group input-group-sm" style="width: 250px;">
            <input type="text" class="form-control" placeholder="Search orders..." id="order-search">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Total Completed</h5>
                        <span class="h2 font-weight-bold mb-0">{{ orders|length }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                    <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 3.48%</span>
                    <span class="text-nowrap">Since last month</span>
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Revenue</h5>
                        <span class="h2 font-weight-bold mb-0">৳{{ total_revenue }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                    <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 12.5%</span>
                    <span class="text-nowrap">Since last month</span>
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">Avg. Order Value</h5>
                        <span class="h2 font-weight-bold mb-0">৳{{ avg_order_value }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                    <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 5.2%</span>
                    <span class="text-nowrap">Since last month</span>
                </p>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h5 class="card-title text-uppercase text-muted mb-0">This Month</h5>
                        <span class="h2 font-weight-bold mb-0">{{ this_month_orders }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                    <span class="text-success mr-2"><i class="fas fa-arrow-up"></i> 8.7%</span>
                    <span class="text-nowrap">Since last month</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Completed Orders List</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="orders-table">
                <thead class="thead-light">
                    <tr>
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="select-all-orders">
                            </div>
                        </th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input select-order" type="checkbox" value="{{ order.id }}">
                            </div>
                        </td>
                        <td>
                            <strong>#{{ order.order_number }}</strong>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="customer-avatar me-3">
                                    {{ order.full_name|first|upper }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ order.full_name }}</div>
                                    <small class="text-muted">{{ order.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-nowrap">{{ order.created_at|date:"M d, Y" }}</div>
                            <small class="text-muted">{{ order.created_at|date:"h:i A" }}</small>
                        </td>
                        <td>
                            <span class="badge amount-badge">৳{{ order.total_amount }}</span>
                        </td>
                        <td>
                            <span class="badge bg-success order-status-badge">
                                <i class="fas fa-check me-1"></i>Delivered
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info order-status-badge">Paid</span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'admin_dashboard:order_detail' order.id %}" 
                                   class="btn btn-sm btn-outline-primary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-secondary" title="Print Invoice">
                                    <i class="fas fa-print"></i>
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                            type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="#">
                                                <i class="fas fa-redo me-2"></i>Resend Confirmation
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#">
                                                <i class="fas fa-shipping-fast me-2"></i>Track Package
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#">
                                                <i class="fas fa-archive me-2"></i>Archive Order
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Completed Orders</h5>
                                <p class="text-muted">All completed orders will appear here.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions mt-3 p-3 bg-light rounded d-none" id="bulk-actions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selected-count">0</span> orders selected
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="bulk-print">
                        <i class="fas fa-print me-1"></i> Print Invoices
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="bulk-export">
                        <i class="fas fa-file-export me-1"></i> Export
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="bulk-archive">
                        <i class="fas fa-archive me-1"></i> Archive
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Quick Filters</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Today's Orders
                        <span class="badge bg-primary rounded-pill">12</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        This Week
                        <span class="badge bg-primary rounded-pill">45</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        This Month
                        <span class="badge bg-primary rounded-pill">189</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        High Value Orders (৳5000+)
                        <span class="badge bg-primary rounded-pill">23</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Recent Activity</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for order in orders|slice:":5" %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between">
                                <strong>Order #{{ order.order_number }}</strong>
                                <small class="text-muted">{{ order.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ order.full_name }} - ৳{{ order.total_amount }}</p>
                            <span class="badge bg-light text-dark">{{ order.created_at|date:"M d, Y h:i A" }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#orders-table').DataTable({
        order: [[3, 'desc']],
        pageLength: 25,
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search orders..."
        }
    });

    // Bulk selection
    $('#select-all-orders').on('change', function() {
        $('.select-order').prop('checked', this.checked);
        updateBulkActions();
    });

    $('.select-order').on('change', function() {
        updateBulkActions();
    });

    function updateBulkActions() {
        const selectedCount = $('.select-order:checked').length;
        $('#selected-count').text(selectedCount);
        
        if (selectedCount > 0) {
            $('#bulk-actions').removeClass('d-none');
        } else {
            $('#bulk-actions').addClass('d-none');
        }
    }

    // Export functionality
    $('#export-orders').on('click', function() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'csv');
        window.location.href = window.location.pathname + '?' + params.toString();
    });

    // Real-time search
    $('#order-search').on('input', function() {
        const table = $('#orders-table').DataTable();
        table.search(this.value).draw();
    });

    // Bulk actions
    $('#bulk-print').on('click', function() {
        const selectedOrders = getSelectedOrders();
        if (selectedOrders.length > 0) {
            // Implement bulk print functionality
            alert(`Printing ${selectedOrders.length} invoices...`);
        }
    });

    $('#bulk-export').on('click', function() {
        const selectedOrders = getSelectedOrders();
        if (selectedOrders.length > 0) {
            // Implement bulk export
            exportSelectedOrders(selectedOrders);
        }
    });

    function getSelectedOrders() {
        return $('.select-order:checked').map(function() {
            return this.value;
        }).get();
    }

    function exportSelectedOrders(orderIds) {
        // AJAX call to export selected orders
        $.ajax({
            url: '{% url "admin_dashboard:completed_orders" %}',
            type: 'POST',
            data: {
                'action': 'export',
                'order_ids': orderIds,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showNotification('Orders exported successfully!', 'success');
                    // Trigger download
                    window.location.href = response.download_url;
                }
            }
        });
    }

    // Quick status update
    $('.quick-status-update').on('change', function() {
        const orderId = $(this).data('order-id');
        const newStatus = $(this).val();
        
        $.ajax({
            url: '{% url "admin_dashboard:update_order_status" %}',
            type: 'POST',
            data: {
                'order_id': orderId,
                'status': newStatus,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showNotification('Order status updated!', 'success');
                }
            }
        });
    });
});
</script>
{% endblock %}