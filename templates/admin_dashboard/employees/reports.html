{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Employee Reports - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.report-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    color: white;
}
.performance-chart {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.metric-card {
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    margin-bottom: 15px;
}
.employee-rank {
    font-size: 1.5em;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Employee Performance Reports</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-primary me-2" id="export-report">
            <i class="fas fa-download me-1"></i> Export Report
        </button>
        <a href="{% url 'admin_dashboard:employee_list' %}" class="btn btn-sm btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Employees
        </a>
    </div>
</div>

<!-- Report Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Report Filters</h5>
            </div>
            <div class="card-body">
                <form method="get" id="report-filters">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department">
                                <option value="">All Departments</option>
                                <option value="sales">Sales</option>
                                <option value="inventory">Inventory</option>
                                <option value="support">Customer Support</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="report-card bg-primary">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-users fa-2x"></i>
                </div>
                <div>
                    <h4 class="mb-0">{{ employees.count }}</h4>
                    <small>Total Employees</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="report-card bg-success">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <div>
                    <h4 class="mb-0">৳0</h4>
                    <small>Total Revenue</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="report-card bg-info">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-shopping-cart fa-2x"></i>
                </div>
                <div>
                    <h4 class="mb-0">0</h4>
                    <small>Orders Processed</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="report-card bg-warning">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-percentage fa-2x"></i>
                </div>
                <div>
                    <h4 class="mb-0">95%</h4>
                    <small>Average Efficiency</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Performance Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Employee Performance Overview</h5>
            </div>
            <div class="card-body">
                <div class="performance-chart">
                    <canvas id="performanceChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Reports -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Employee Performance Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="performance-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Position</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Efficiency</th>
                                <th>Rating</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in reports_data %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{% if data.employee.user.profile.image %}{{ data.employee.user.profile.image.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                                             alt="{{ data.employee.user.get_full_name }}" 
                                             class="rounded me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                        <div>
                                            <strong class="d-block">{{ data.employee.user.get_full_name }}</strong>
                                            <small class="text-muted">{{ data.employee.employee_id }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ data.employee.position }}</td>
                                <td>
                                    <span class="badge bg-primary rounded-pill">{{ data.orders_processed }}</span>
                                </td>
                                <td>
                                    <strong>৳{{ data.total_sales }}</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar bg-success" style="width: {{ data.efficiency }}"></div>
                                        </div>
                                        <small>{{ data.efficiency }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-warning">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star-half-alt"></i>
                                    </div>
                                </td>
                                <td>
                                    {% if data.employee.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Top Performers -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Performers</h5>
            </div>
            <div class="card-body">
                {% for data in reports_data|slice:":5" %}
                <div class="d-flex align-items-center mb-3">
                    <div class="employee-rank me-3 text-primary">
                        #{{ forloop.counter }}
                    </div>
                    <img src="{% if data.employee.user.profile.image %}{{ data.employee.user.profile.image.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" 
                         alt="{{ data.employee.user.get_full_name }}" 
                         class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                    <div class="flex-grow-1">
                        <strong class="d-block">{{ data.employee.user.get_full_name }}</strong>
                        <small class="text-muted">{{ data.employee.position }}</small>
                    </div>
                    <div class="text-end">
                        <strong class="text-success">৳{{ data.total_sales }}</strong>
                        <div class="text-warning small">
                            <i class="fas fa-star"></i> 4.8
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Key Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="metric-card">
                            <h3 class="text-primary mb-1">95%</h3>
                            <small class="text-muted">Avg. Efficiency</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="metric-card">
                            <h3 class="text-success mb-1">4.7</h3>
                            <small class="text-muted">Avg. Rating</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card">
                            <h3 class="text-info mb-1">25</h3>
                            <small class="text-muted">Avg. Orders/Day</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card">
                            <h3 class="text-warning mb-1">98%</h3>
                            <small class="text-muted">On-time Delivery</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Report Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="generate-pdf">
                        <i class="fas fa-file-pdf me-1"></i> Generate PDF
                    </button>
                    <button class="btn btn-outline-success" id="send-report">
                        <i class="fas fa-envelope me-1"></i> Email Report
                    </button>
                    <button class="btn btn-outline-info" id="schedule-report">
                        <i class="fas fa-calendar me-1"></i> Schedule Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Initialize performance chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [
                {% for data in reports_data %}
                '{{ data.employee.user.first_name }}',
                {% endfor %}
            ],
            datasets: [{
                label: 'Revenue (৳)',
                data: [
                    {% for data in reports_data %}
                    {{ data.total_sales }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Orders Processed',
                data: [
                    {% for data in reports_data %}
                    {{ data.orders_processed }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Export report
    $('#export-report').on('click', function() {
        showNotification('Exporting report...', 'info');
        // Export logic would go here
    });

    // Generate PDF
    $('#generate-pdf').on('click', function() {
        showNotification('Generating PDF report...', 'info');
        // PDF generation logic would go here
    });

    // Send report via email
    $('#send-report').on('click', function() {
        if (confirm('Send this report via email?')) {
            showNotification('Sending report via email...', 'info');
            // Email sending logic would go here
        }
    });

    // Schedule report
    $('#schedule-report').on('click', function() {
        showNotification('Opening schedule settings...', 'info');
        // Schedule logic would go here
    });
});

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('.alert-dismissible').alert('close');
    $('.messages-container').html(notification);
    
    setTimeout(() => notification.alert('close'), 5000);
}
</script>
{% endblock %}