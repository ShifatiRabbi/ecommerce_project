{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Header Design - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Header Design Manager</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-success" id="save-header-design">
            <i class="fas fa-save me-1"></i> Save Changes
        </button>
    </div>
</div>

<div class="row">
    <!-- Header Templates -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Header Templates</h5>
            </div>
            <div class="card-body">
                <div class="header-templates">
                    {% for header in header_templates %}
                    <div class="header-template-card {% if header.is_active %}active{% endif %}" 
                         data-header-id="{{ header.id }}">
                        <div class="template-preview">
                            <div class="template-header {{ header.layout }}">
                                <div class="header-content">
                                    {% if header.layout == 'logo_left' %}
                                    <div class="logo">Logo</div>
                                    <div class="search">Search Bar</div>
                                    <div class="icons">Icons</div>
                                    {% elif header.layout == 'logo_center' %}
                                    <div class="menu">Categories</div>
                                    <div class="logo">Logo</div>
                                    <div class="icons">Icons</div>
                                    {% elif header.layout == 'minimal' %}
                                    <div class="logo">Logo</div>
                                    <div class="menu-icons">
                                        <span>Menu</span>
                                        <span>Icons</span>
                                    </div>
                                    {% elif header.layout == 'centered' %}
                                    <div class="logo-menu">
                                        <div class="logo">Logo</div>
                                        <div class="menu">Navigation</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="template-info">
                            <h6>{{ header.name }}</h6>
                            <p class="text-muted mb-2">{{ header.description }}</p>
                            <div class="template-actions">
                                <button class="btn btn-sm btn-outline-primary preview-header" 
                                        data-header-id="{{ header.id }}">
                                    <i class="fas fa-eye me-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-outline-success select-header {% if header.is_active %}d-none{% endif %}" 
                                        data-header-id="{{ header.id }}">
                                    <i class="fas fa-check me-1"></i> Select
                                </button>
                                <span class="badge bg-success selected-badge {% if not header.is_active %}d-none{% endif %}">
                                    <i class="fas fa-check me-1"></i> Active
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Header Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Header Settings</h5>
            </div>
            <div class="card-body">
                <form id="header-settings-form">
                    <div class="mb-3">
                        <label class="form-label">Sticky Header</label>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" name="sticky_header" 
                                   id="sticky-header" {% if site_settings.sticky_header %}checked{% endif %}>
                            <label class="form-check-label" for="sticky-header">Enable sticky header on scroll</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Header Background</label>
                        <input type="color" class="form-control" name="header_bg" 
                               value="{{ site_settings.header_background }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Text Color</label>
                        <input type="color" class="form-control" name="text_color" 
                               value="{{ site_settings.header_text_color }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Header Height</label>
                        <input type="range" class="form-range" name="header_height" min="60" max="120" 
                               value="{{ site_settings.header_height }}">
                        <div class="form-text text-end" id="height-value">{{ site_settings.header_height }}px</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Logo Size</label>
                        <input type="range" class="form-range" name="logo_size" min="30" max="80" 
                               value="{{ site_settings.logo_size }}">
                        <div class="form-text text-end" id="logo-size-value">{{ site_settings.logo_size }}px</div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Live Preview -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Live Preview - {{ active_header.name }}</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active preview-desktop">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary preview-tablet">
                        <i class="fas fa-tablet-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary preview-mobile">
                        <i class="fas fa-mobile-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="preview-container" id="preview-container">
                    <div class="device-frame desktop">
                        <div class="device-screen">
                            <!-- Active Header Preview -->
                            <div id="header-preview">
                                {% include header_template %}
                            </div>
                            
                            <!-- Sample Content -->
                            <div class="preview-content">
                                <div class="content-placeholder"></div>
                                <div class="content-placeholder"></div>
                                <div class="content-placeholder"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customization Options -->
                <div class="customization-options mt-4">
                    <h6>Customize Active Header</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Menu Items</label>
                            <div id="menu-items-container">
                                {% for item in menu_items %}
                                <div class="menu-item d-flex align-items-center mb-2">
                                    <input type="text" class="form-control form-control-sm me-2 menu-title" 
                                           value="{{ item.title }}" placeholder="Menu text" data-id="{{ item.id }}">
                                    <input type="text" class="form-control form-control-sm me-2 menu-url" 
                                           value="{{ item.url }}" placeholder="URL" data-id="{{ item.id }}">
                                    <button class="btn btn-sm btn-outline-danger remove-menu-item" data-id="{{ item.id }}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% empty %}
                                <div class="menu-item d-flex align-items-center mb-2">
                                    <input type="text" class="form-control form-control-sm me-2 menu-title" 
                                           value="Home" placeholder="Menu text" data-id="1">
                                    <input type="text" class="form-control form-control-sm me-2 menu-url" 
                                           value="/" placeholder="URL" data-id="1">
                                    <button class="btn btn-sm btn-outline-danger remove-menu-item" data-id="1">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="menu-item d-flex align-items-center mb-2">
                                    <input type="text" class="form-control form-control-sm me-2 menu-title" 
                                           value="Shop" placeholder="Menu text" data-id="2">
                                    <input type="text" class="form-control form-control-sm me-2 menu-url" 
                                           value="/shop/" placeholder="URL" data-id="2">
                                    <button class="btn btn-sm btn-outline-danger remove-menu-item" data-id="2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-sm btn-outline-primary mt-2" id="add-menu-item">
                                <i class="fas fa-plus me-1"></i> Add Menu Item
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Header Elements</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input header-element" name="show_search" 
                                       id="show-search" {% if header_settings.show_search %}checked{% endif %}>
                                <label class="form-check-label" for="show-search">Show Search Icon</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input header-element" name="show_user" 
                                       id="show-user" {% if header_settings.show_user %}checked{% endif %}>
                                <label class="form-check-label" for="show-user">Show User Account</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input header-element" name="show_cart" 
                                       id="show-cart" {% if header_settings.show_cart %}checked{% endif %}>
                                <label class="form-check-label" for="show-cart">Show Shopping Cart</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input header-element" name="show_language" 
                                       id="show-language" {% if header_settings.show_language %}checked{% endif %}>
                                <label class="form-check-label" for="show-language">Show Language Switcher</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input header-element" name="show_wishlist" 
                                       id="show-wishlist" {% if header_settings.show_wishlist %}checked{% endif %}>
                                <label class="form-check-label" for="show-wishlist">Show Wishlist</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Custom CSS -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Custom CSS</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Custom Header CSS</label>
                    <textarea class="form-control" id="custom-header-css" rows="6" 
                              placeholder="Add custom CSS for header styling...">{{ site_settings.custom_css }}</textarea>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Use this area to add custom CSS styles that will be applied to the header.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.header-template-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.header-template-card:hover {
    border-color: #007bff;
}

.header-template-card.active {
    border-color: #28a745;
    background-color: #f8fff9;
}

.template-preview {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.template-header {
    background: white;
    padding: 10px;
    border-radius: 4px;
    font-size: 12px;
    min-height: 50px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.logo {
    font-weight: bold;
    color: #007bff;
    background: #e3f2fd;
    padding: 4px 8px;
    border-radius: 3px;
}

.search {
    background: #f5f5f5;
    padding: 4px 8px;
    border-radius: 3px;
    flex-grow: 1;
    text-align: center;
}

.icons {
    background: #fff3e0;
    padding: 4px 8px;
    border-radius: 3px;
}

.menu {
    background: #e8f5e8;
    padding: 4px 8px;
    border-radius: 3px;
}

.logo-menu {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    width: 100%;
}

.preview-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
}

.device-frame {
    max-width: 100%;
    margin: 0 auto;
    border: 2px solid #333;
    border-radius: 12px;
    background: white;
    overflow: hidden;
}

.device-frame.desktop {
    max-width: 100%;
}

.device-frame.tablet {
    max-width: 768px;
}

.device-frame.mobile {
    max-width: 375px;
}

.device-screen {
    background: white;
    min-height: 400px;
}

.preview-content .content-placeholder {
    height: 200px;
    background: #e9ecef;
    margin: 10px;
    border-radius: 4px;
}

.template-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.menu-item {
    background: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}

.customization-options {
    border-top: 1px solid #e9ecef;
    padding-top: 20px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let menuItemCounter = {{ menu_items|length|default:2 }};
    
    // Header template selection
    $('.select-header').on('click', function() {
        const headerId = $(this).data('header-id');
        
        $.ajax({
            url: '{% url "admin_dashboard:ajax_set_active_header" %}',
            type: 'POST',
            data: {
                'header_id': headerId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showNotification('Header template activated!', 'success');
                    
                    // Update UI
                    $('.header-template-card').removeClass('active');
                    $('.select-header').removeClass('d-none');
                    $('.selected-badge').addClass('d-none');
                    
                    $(`.header-template-card[data-header-id="${headerId}"]`).addClass('active');
                    $(`.select-header[data-header-id="${headerId}"]`).addClass('d-none');
                    $(`.selected-badge[data-header-id="${headerId}"]`).removeClass('d-none');
                    
                    // Reload preview
                    location.reload();
                }
            }
        });
    });

    // Preview header
    $('.preview-header').on('click', function() {
        const headerId = $(this).data('header-id');
        
        $.ajax({
            url: '{% url "admin_dashboard:ajax_preview_header" %}',
            type: 'POST',
            data: {
                'header_id': headerId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $('#header-preview').html(response.html);
                    showNotification('Preview updated!', 'info');
                }
            }
        });
    });

    // Settings form changes
    $('#header-settings-form input').on('change input', function() {
        updateHeaderPreviewFromSettings();
    });

    // Range inputs
    $('input[type="range"]').on('input', function() {
        const value = $(this).val();
        const target = $(this).attr('name') + '-value';
        $('#' + target).text(value + 'px');
        updateHeaderPreviewFromSettings();
    });

    // Add menu item
    $('#add-menu-item').on('click', function() {
        menuItemCounter++;
        const newItem = $(`
            <div class="menu-item d-flex align-items-center mb-2">
                <input type="text" class="form-control form-control-sm me-2 menu-title" 
                       placeholder="Menu text" data-id="${menuItemCounter}">
                <input type="text" class="form-control form-control-sm me-2 menu-url" 
                       placeholder="URL" value="#" data-id="${menuItemCounter}">
                <button class="btn btn-sm btn-outline-danger remove-menu-item" data-id="${menuItemCounter}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `);
        $('#menu-items-container').append(newItem);
        updateHeaderPreviewFromMenu();
    });

    // Remove menu item
    $(document).on('click', '.remove-menu-item', function() {
        const itemId = $(this).data('id');
        $(this).closest('.menu-item').remove();
        updateHeaderPreviewFromMenu();
    });

    // Menu item changes
    $(document).on('input', '.menu-title, .menu-url', function() {
        updateHeaderPreviewFromMenu();
    });

    // Header element toggles
    $('.header-element').on('change', function() {
        updateHeaderPreviewFromElements();
    });

    // Save header design
    $('#save-header-design').on('click', function() {
        const settings = $('#header-settings-form').serializeArray();
        const customCSS = $('#custom-header-css').val();
        const menuItems = getMenuItems();
        const headerElements = getHeaderElements();
        
        $.ajax({
            url: '{% url "admin_dashboard:ajax_save_header_settings" %}',
            type: 'POST',
            data: {
                'settings': JSON.stringify(settings),
                'menu_items': JSON.stringify(menuItems),
                'header_elements': JSON.stringify(headerElements),
                'custom_css': customCSS,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showNotification('Header design saved successfully!', 'success');
                }
            }
        });
    });

    // Preview device type
    $('.preview-desktop, .preview-tablet, .preview-mobile').on('click', function() {
        $('.preview-desktop, .preview-tablet, .preview-mobile').removeClass('active');
        $(this).addClass('active');
        
        const device = $(this).hasClass('preview-desktop') ? 'desktop' : 
                      $(this).hasClass('preview-tablet') ? 'tablet' : 'mobile';
        
        $('.device-frame').removeClass('desktop tablet mobile').addClass(device);
    });

    function updateHeaderPreviewFromSettings() {
        const formData = $('#header-settings-form').serializeArray();
        const settings = {};
        
        formData.forEach(item => {
            if (item.name === 'sticky_header') {
                settings[item.name] = item.value === 'on';
            } else {
                settings[item.name] = item.value;
            }
        });
        
        // Apply CSS variables to preview
        $('#header-preview').css({
            '--header-bg': settings.header_bg,
            '--header-text': settings.text_color,
            '--header-height': settings.header_height + 'px',
            '--logo-size': settings.logo_size + 'px'
        });
        
        // Update sticky header
        if (settings.sticky_header) {
            $('#header-preview .main-header').addClass('sticky-header');
        } else {
            $('#header-preview .main-header').removeClass('sticky-header');
        }
    }

    function updateHeaderPreviewFromMenu() {
        const menuItems = getMenuItems();
        
        // Update menu items in preview
        $('#header-preview .navbar-nav').html('');
        menuItems.forEach(item => {
            if (item.title && item.url) {
                $('#header-preview .navbar-nav').append(`
                    <li class="nav-item">
                        <a class="nav-link" href="${item.url}">${item.title}</a>
                    </li>
                `);
            }
        });
    }

    function updateHeaderPreviewFromElements() {
        const elements = getHeaderElements();
        
        // Toggle search
        if (elements.show_search) {
            $('#header-preview .search-container, #header-preview .search-toggle').show();
        } else {
            $('#header-preview .search-container, #header-preview .search-toggle').hide();
        }
        
        // Toggle user account
        if (elements.show_user) {
            $('#header-preview .user-account, #header-preview .fa-user').closest('a, .dropdown').show();
        } else {
            $('#header-preview .user-account, #header-preview .fa-user').closest('a, .dropdown').hide();
        }
        
        // Toggle cart
        if (elements.show_cart) {
            $('#header-preview .shopping-cart, #header-preview .fa-shopping-cart').closest('a').show();
        } else {
            $('#header-preview .shopping-cart, #header-preview .fa-shopping-cart').closest('a').hide();
        }
        
        // Toggle language switcher
        if (elements.show_language) {
            $('#header-preview .language-switcher, #header-preview .fa-globe').closest('.dropdown').show();
        } else {
            $('#header-preview .language-switcher, #header-preview .fa-globe').closest('.dropdown').hide();
        }
        
        // Toggle wishlist
        if (elements.show_wishlist) {
            $('#header-preview .wishlist, #header-preview .fa-heart').closest('a').show();
        } else {
            $('#header-preview .wishlist, #header-preview .fa-heart').closest('a').hide();
        }
    }

    function getMenuItems() {
        const menuItems = [];
        $('#menu-items-container .menu-item').each(function() {
            const title = $(this).find('.menu-title').val();
            const url = $(this).find('.menu-url').val();
            const id = $(this).find('.menu-title').data('id');
            if (title && url) {
                menuItems.push({ id: id, title: title, url: url });
            }
        });
        return menuItems;
    }

    function getHeaderElements() {
        return {
            show_search: $('#show-search').is(':checked'),
            show_user: $('#show-user').is(':checked'),
            show_cart: $('#show-cart').is(':checked'),
            show_language: $('#show-language').is(':checked'),
            show_wishlist: $('#show-wishlist').is(':checked')
        };
    }

    // Initialize
    updateHeaderPreviewFromSettings();
    updateHeaderPreviewFromMenu();
    updateHeaderPreviewFromElements();
});

function showNotification(message, type) {
    // Simple notification function
    const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
    const alert = $(`<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`);
    
    $('.container').first().prepend(alert);
    
    setTimeout(() => {
        alert.alert('close');
    }, 3000);
}
</script>
{% endblock %}