{% extends 'admin_dashboard/base.html' %}
{% load static crispy_forms_tags %}

{% block title %}Add New Product - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.image-preview {
    max-width: 200px;
    max-height: 200px;
    border: 2px dashed #ddd;
    padding: 10px;
    margin: 10px 0;
}
.upload-area {
    border: 2px dashed #007bff;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.upload-area:hover {
    border-color: #0056b3;
    background-color: #f8f9fa;
}
.upload-area.dragover {
    border-color: #28a745;
    background-color: #e8f5e8;
}
.image-thumbnail {
    position: relative;
    display: inline-block;
    margin: 5px;
}
.image-thumbnail img {
    width: 100px;
    height: 100px;
    object-fit: cover;
}
.remove-image {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
}
.tab-pane {
    padding: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Add New Product</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'admin_dashboard:product_list' %}" class="btn btn-sm btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Products
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" 
                                data-bs-target="#basic" type="button" role="tab">
                            <i class="fas fa-info-circle me-1"></i> Basic Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pricing-tab" data-bs-toggle="tab" 
                                data-bs-target="#pricing" type="button" role="tab">
                            <i class="fas fa-tag me-1"></i> Pricing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="images-tab" data-bs-toggle="tab" 
                                data-bs-target="#images" type="button" role="tab">
                            <i class="fas fa-images me-1"></i> Images
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" 
                                data-bs-target="#inventory" type="button" role="tab">
                            <i class="fas fa-boxes me-1"></i> Inventory
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="seo-tab" data-bs-toggle="tab" 
                                data-bs-target="#seo" type="button" role="tab">
                            <i class="fas fa-search me-1"></i> SEO
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="product-form">
                    {% csrf_token %}
                    
                    <div class="tab-content" id="productTabsContent">
                        <!-- Basic Information Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Product Name *</label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                        <div class="text-danger">{{ form.name.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Product Name (Bengali)</label>
                                        {{ form.name_bn }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Slug *</label>
                                        {{ form.slug }}
                                        <small class="form-text text-muted">URL-friendly version of the name</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Category *</label>
                                        {{ form.category }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Short Description</label>
                                {{ form.short_description }}
                                <small class="form-text text-muted">Brief description for product listings</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Short Description (Bengali)</label>
                                {{ form.short_description_bn }}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Full Description *</label>
                                {{ form.description }}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Full Description (Bengali)</label>
                                {{ form.description_bn }}
                            </div>
                        </div>

                        <!-- Pricing Tab -->
                        <div class="tab-pane fade" id="pricing" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Price (৳) *</label>
                                        {{ form.price }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Compare Price (৳)</label>
                                        {{ form.compare_price }}
                                        <small class="form-text text-muted">Original price for showing discounts</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">SKU *</label>
                                        {{ form.sku }}
                                        <small class="form-text text-muted">Unique stock keeping unit</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        {{ form.is_active }}
                                        <label class="form-check-label">Active Product</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        {{ form.is_featured }}
                                        <label class="form-check-label">Featured Product</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Images Tab -->
                        <div class="tab-pane fade" id="images" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Main Product Image *</label>
                                <input type="file" class="form-control" name="main_image" accept="image/*" 
                                       id="main-image-input" required>
                                <div class="image-preview mt-2" id="main-image-preview"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Additional Images</label>
                                <div class="upload-area" id="upload-area">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drag & Drop Images Here</h5>
                                    <p class="text-muted">or click to browse</p>
                                    <input type="file" class="d-none" name="additional_images" 
                                           id="additional-images-input" multiple accept="image/*">
                                </div>
                                <div class="image-thumbnails mt-3" id="image-thumbnails"></div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Image Guidelines:</strong> Use high-quality images. Recommended size: 800x800px. 
                                Max file size: 2MB per image.
                            </div>
                        </div>

                        <!-- Inventory Tab -->
                        <div class="tab-pane fade" id="inventory" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Initial Stock Quantity *</label>
                                        <input type="number" class="form-control" name="initial_stock" 
                                               value="0" min="0" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Low Stock Threshold</label>
                                        <input type="number" class="form-control" name="low_stock_threshold" 
                                               value="10" min="1">
                                        <small class="form-text text-muted">Get alerts when stock falls below this number</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Inventory Management:</strong> Stock levels will be automatically updated as orders are placed.
                            </div>
                        </div>

                        <!-- SEO Tab -->
                        <div class="tab-pane fade" id="seo" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Meta Title</label>
                                <input type="text" class="form-control" name="meta_title" 
                                       placeholder="Optimized title for search engines">
                                <small class="form-text text-muted">Recommended: 50-60 characters</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Meta Description</label>
                                <textarea class="form-control" name="meta_description" rows="3" 
                                          placeholder="Brief description for search results"></textarea>
                                <small class="form-text text-muted">Recommended: 150-160 characters</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Focus Keywords</label>
                                <input type="text" class="form-control" name="focus_keywords" 
                                       placeholder="keyword1, keyword2, keyword3">
                                <small class="form-text text-muted">Separate keywords with commas</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i> Save Product
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg" id="save-draft">
                            <i class="fas fa-file-alt me-2"></i> Save as Draft
                        </button>
                        <a href="{% url 'admin_dashboard:product_list' %}" class="btn btn-outline-secondary btn-lg">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Product Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Product Preview</h5>
            </div>
            <div class="card-body">
                <div class="text-center" id="product-preview">
                    <div class="bg-light rounded p-5 mb-3">
                        <i class="fas fa-cube fa-3x text-muted"></i>
                    </div>
                    <h5 id="preview-name">Product Name</h5>
                    <div class="text-muted mb-2" id="preview-category">Category</div>
                    <div class="h4 text-primary mb-3" id="preview-price">৳0.00</div>
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" disabled>Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" id="duplicate-product">
                        <i class="fas fa-copy me-2"></i>Duplicate from Existing
                    </button>
                    <button type="button" class="btn btn-outline-success" id="import-products">
                        <i class="fas fa-file-import me-2"></i>Import from CSV
                    </button>
                    <button type="button" class="btn btn-outline-info" id="generate-seo">
                        <i class="fas fa-magic me-2"></i>Auto-Generate SEO
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Progress Indicator -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Setup Progress</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Basic Information</span>
                        <span id="basic-progress">0%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" id="basic-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Pricing</span>
                        <span id="pricing-progress">0%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" id="pricing-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Images</span>
                        <span id="images-progress">0%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" id="images-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Inventory</span>
                        <span id="inventory-progress">0%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" id="inventory-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Image preview for main image
    $('#main-image-input').on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#main-image-preview').html(
                    `<img src="${e.target.result}" class="img-fluid" alt="Preview">`
                );
                updateProgress('images', 100);
            };
            reader.readAsDataURL(file);
        }
    });

    // Drag and drop for additional images
    const uploadArea = $('#upload-area');
    const fileInput = $('#additional-images-input');
    
    uploadArea.on('click', function() {
        fileInput.click();
    });
    
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        uploadArea.addClass('dragover');
    });
    
    uploadArea.on('dragleave', function() {
        uploadArea.removeClass('dragover');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        uploadArea.removeClass('dragover');
        const files = e.originalEvent.dataTransfer.files;
        handleFiles(files);
    });
    
    fileInput.on('change', function(e) {
        handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
        for (let file of files) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const thumbnail = $(`
                        <div class="image-thumbnail">
                            <img src="${e.target.result}" alt="Thumbnail">
                            <div class="remove-image" onclick="$(this).parent().remove(); updateImageCount();">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `);
                    $('#image-thumbnails').append(thumbnail);
                    updateImageCount();
                };
                reader.readAsDataURL(file);
            }
        }
    }
    
    function updateImageCount() {
        const count = $('#image-thumbnails .image-thumbnail').length;
        updateProgress('images', Math.min(count * 20, 100));
    }

    // Real-time preview updates
    $('input[name="name"]').on('input', function() {
        $('#preview-name').text($(this).val() || 'Product Name');
        updateProgress('basic', $(this).val() ? 25 : 0);
    });
    
    $('select[name="category"]').on('change', function() {
        const categoryName = $(this).find('option:selected').text();
        $('#preview-category').text(categoryName || 'Category');
        updateProgress('basic', categoryName ? 50 : 25);
    });
    
    $('textarea[name="short_description"]').on('input', function() {
        updateProgress('basic', $(this).val() ? 75 : 50);
    });
    
    $('textarea[name="description"]').on('input', function() {
        updateProgress('basic', $(this).val() ? 100 : 75);
    });
    
    $('input[name="price"]').on('input', function() {
        $('#preview-price').text('৳' + ($(this).val() || '0.00'));
        updateProgress('pricing', $(this).val() ? 100 : 0);
    });

    // Progress tracking
    function updateProgress(section, percent) {
        $(`#${section}-progress`).text(percent + '%');
        $(`#${section}-progress-bar`).css('width', percent + '%');
        
        if (percent === 100) {
            $(`#${section}-progress-bar`).addClass('bg-success');
        } else {
            $(`#${section}-progress-bar`).removeClass('bg-success');
        }
    }

    // Auto-generate slug from name
    $('input[name="name"]').on('blur', function() {
        if (!$('input[name="slug"]').val()) {
            const slug = $(this).val().toLowerCase()
                .replace(/[^a-z0-9 -]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
            $('input[name="slug"]').val(slug);
        }
    });

    // Auto-generate SEO
    $('#generate-seo').on('click', function() {
        const name = $('input[name="name"]').val();
        const description = $('textarea[name="short_description"]').val();
        
        if (name) {
            $('input[name="meta_title"]').val(name + ' - Buy Online at {{ site_settings.site_name }}');
            $('textarea[name="meta_description"]').val(
                description || `Buy ${name} online at {{ site_settings.site_name }}. Best quality, competitive prices. Fast delivery.`
            );
            
            showNotification('SEO content generated successfully!', 'success');
        }
    });

    // Save as draft
    $('#save-draft').on('click', function() {
        $('#product-form').append('<input type="hidden" name="is_draft" value="true">');
        $('#product-form').submit();
    });

    // Form validation
    $('#product-form').on('submit', function(e) {
        let valid = true;
        
        // Basic validation
        if (!$('input[name="name"]').val()) {
            showNotification('Product name is required', 'error');
            valid = false;
        }
        
        if (!$('input[name="price"]').val() || parseFloat($('input[name="price"]').val()) <= 0) {
            showNotification('Valid price is required', 'error');
            valid = false;
        }
        
        if (!$('input[name="sku"]').val()) {
            showNotification('SKU is required', 'error');
            valid = false;
        }
        
        if (!valid) {
            e.preventDefault();
            // Switch to the first tab with error
            $('#basic-tab').tab('show');
        }
    });

    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            $('#product-form').submit();
        }
    });

    // Initialize progress based on current values
    if ($('input[name="name"]').val()) updateProgress('basic', 25);
    if ($('select[name="category"]').val()) updateProgress('basic', 50);
    if ($('textarea[name="short_description"]').val()) updateProgress('basic', 75);
    if ($('textarea[name="description"]').val()) updateProgress('basic', 100);
    if ($('input[name="price"]').val()) updateProgress('pricing', 100);
});

function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('.alert-dismissible').alert('close');
    $('.messages-container').html(notification);
    
    setTimeout(() => notification.alert('close'), 5000);
}
</script>
{% endblock %}